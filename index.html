<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta name="theme-color" content="#0a0f1a">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Replace Deeds">
<link rel="manifest" href="manifest.json">
<title>Replace Deeds</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
:root {
  --bg: #080c14;
  --bg2: #0f1520;
  --bg3: #141c2e;
  --card: #111827;
  --card2: #1a2338;
  --border: #1e2d47;
  --accent: #00d4ff;
  --accent2: #0098b8;
  --accent-soft: rgba(0,212,255,0.12);
  --green: #00e676;
  --yellow: #ffd740;
  --orange: #ff6d00;
  --red: #ff1744;
  --text: #e8f4f8;
  --text2: #8ba3bc;
  --text3: #4a6278;
  --radius: 18px;
  --radius-sm: 10px;
  --shadow: 0 8px 32px rgba(0,0,0,0.5);
  --glow: 0 0 20px rgba(0,212,255,0.3);
}

* { margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent; }

body {
  background: var(--bg);
  color: var(--text);
  font-family: 'DM Sans', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
  padding-bottom: 90px;
}

h1,h2,h3,.title { font-family: 'Syne', sans-serif; }

/* ===== SPLASH ===== */
#splash {
  position: fixed; inset: 0; z-index: 9999;
  background: var(--bg);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  gap: 20px;
}
.splash-logo {
  width: 100px; height: 100px;
  animation: splashPulse 1.5s ease-in-out infinite;
}
.splash-title {
  font-family: 'Syne', sans-serif;
  font-size: 28px; font-weight: 800;
  background: linear-gradient(135deg, var(--accent), #7c3aed);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.splash-sub { color: var(--text2); font-size: 13px; }
@keyframes splashPulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.7;transform:scale(0.95)} }

/* ===== ONBOARDING ===== */
#onboarding {
  position: fixed; inset: 0; z-index: 9998;
  background: var(--bg);
  display: none; flex-direction: column;
  overflow-y: auto;
}
.onboard-screen {
  min-height: 100vh; padding: 40px 24px;
  display: flex; flex-direction: column;
  justify-content: center; gap: 24px;
}
.onboard-icon { font-size: 60px; text-align: center; }
.onboard-title { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; text-align: center; }
.onboard-desc { color: var(--text2); text-align: center; line-height: 1.6; }

/* ===== FORMS ===== */
.form-group { display: flex; flex-direction: column; gap: 8px; }
.form-label { font-size: 12px; font-weight: 600; color: var(--text2); text-transform: uppercase; letter-spacing: 1px; }
.form-input {
  background: var(--card);
  border: 1.5px solid var(--border);
  border-radius: var(--radius-sm);
  color: var(--text); font-family: 'DM Sans', sans-serif;
  font-size: 15px; padding: 14px 16px;
  outline: none; transition: border-color 0.2s, box-shadow 0.2s;
  width: 100%;
}
.form-input:focus { border-color: var(--accent); box-shadow: var(--glow); }

/* ===== BUTTONS ===== */
.btn {
  padding: 16px 24px; border-radius: var(--radius-sm);
  border: none; font-family: 'Syne', sans-serif;
  font-size: 15px; font-weight: 700;
  cursor: pointer; transition: all 0.2s;
  width: 100%;
}
.btn-primary {
  background: linear-gradient(135deg, var(--accent), var(--accent2));
  color: #000;
  box-shadow: 0 4px 20px rgba(0,212,255,0.3);
}
.btn-primary:active { transform: scale(0.97); }
.btn-secondary {
  background: var(--card); color: var(--text2);
  border: 1.5px solid var(--border);
}
.btn-danger { background: rgba(255,23,68,0.1); color: var(--red); border: 1.5px solid rgba(255,23,68,0.2); }
.btn-sm { padding: 8px 14px; font-size: 13px; width: auto; border-radius: 8px; }

/* ===== NAV ===== */
#nav {
  position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
  background: rgba(11,17,30,0.95);
  backdrop-filter: blur(20px);
  border-top: 1px solid var(--border);
  display: flex; padding: 8px 0 calc(8px + env(safe-area-inset-bottom));
}
.nav-item {
  flex: 1; display: flex; flex-direction: column;
  align-items: center; gap: 4px;
  padding: 8px 0; cursor: pointer;
  color: var(--text3); font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 0.5px;
  transition: color 0.2s;
}
.nav-item.active { color: var(--accent); }
.nav-icon { font-size: 22px; }

/* ===== PAGES ===== */
.page { display: none; padding: 20px 16px; max-width: 420px; margin: 0 auto; }
.page.active { display: block; }

/* ===== HEADER ===== */
.page-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 20px; padding-top: 8px;
}
.page-title { font-size: 24px; font-weight: 800; }

/* ===== STREAK CARD ===== */
.streak-card {
  background: linear-gradient(135deg, var(--card), var(--card2));
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px;
  margin-bottom: 16px;
  position: relative; overflow: hidden;
}
.streak-card::before {
  content: ''; position: absolute; inset: 0;
  background: radial-gradient(circle at 70% 50%, rgba(0,212,255,0.05), transparent 60%);
  pointer-events: none;
}
.streak-main {
  display: flex; align-items: center; gap: 16px;
}
.streak-fire {
  font-size: 48px;
  filter: drop-shadow(0 0 12px rgba(255,152,0,0.6));
  animation: fireWiggle 2s ease-in-out infinite;
}
@keyframes fireWiggle { 0%,100%{transform:rotate(-5deg)} 50%{transform:rotate(5deg)} }
.streak-num {
  font-family: 'Syne', sans-serif;
  font-size: 52px; font-weight: 800;
  line-height: 1;
  background: linear-gradient(135deg, #ff9800, #ff5722);
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}
.streak-label { color: var(--text2); font-size: 13px; margin-top: 4px; }
.streak-frozen { background: linear-gradient(135deg, rgba(0,150,255,0.15), rgba(0,100,200,0.05)); }
.freeze-badge {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(0,150,255,0.15); border: 1px solid rgba(0,150,255,0.3);
  border-radius: 20px; padding: 4px 12px; font-size: 12px; font-weight: 600;
  color: #4fc3f7; margin-top: 8px;
}

/* ===== SECTIONS ===== */
.section-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 12px;
}
.section-title {
  font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 700;
  color: var(--text);
}
.section-emoji { font-size: 18px; margin-right: 6px; }

/* ===== HABIT CARD ===== */
.habit-card {
  background: var(--card);
  border: 1px solid var(--border);
  border-radius: var(--radius-sm);
  padding: 14px 16px;
  display: flex; align-items: center; gap: 12px;
  margin-bottom: 8px;
  transition: all 0.25s;
  cursor: pointer;
  position: relative; overflow: hidden;
}
.habit-card.completed {
  border-color: rgba(0,230,118,0.3);
  background: rgba(0,230,118,0.05);
}
.habit-card.completed::after {
  content: ''; position: absolute;
  left: 0; top: 0; bottom: 0; width: 3px;
  background: var(--green);
}
.habit-check {
  width: 28px; height: 28px; border-radius: 8px;
  border: 2px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0; font-size: 14px;
  transition: all 0.2s;
}
.habit-card.completed .habit-check {
  background: var(--green); border-color: var(--green); color: #000;
}
.habit-info { flex: 1; }
.habit-name { font-size: 15px; font-weight: 500; }
.habit-card.completed .habit-name { color: var(--text2); text-decoration: line-through; }
.habit-meta { font-size: 11px; color: var(--text3); margin-top: 2px; }
.habit-streak-badge {
  background: rgba(255,152,0,0.15); border: 1px solid rgba(255,152,0,0.3);
  border-radius: 12px; padding: 2px 8px;
  font-size: 11px; font-weight: 600; color: #ff9800;
}

/* ===== ADD SECTION ===== */
.add-section-btn {
  width: 100%; padding: 14px;
  background: transparent; border: 1.5px dashed var(--border);
  border-radius: var(--radius-sm); color: var(--text3);
  font-family: 'DM Sans', sans-serif; font-size: 14px;
  cursor: pointer; transition: all 0.2s;
  display: flex; align-items: center; justify-content: center; gap: 8px;
}
.add-section-btn:hover { border-color: var(--accent); color: var(--accent); }

.section-block {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px;
  margin-bottom: 16px;
}

/* ===== MODAL ===== */
.modal-overlay {
  position: fixed; inset: 0; z-index: 1000;
  background: rgba(0,0,0,0.7); backdrop-filter: blur(8px);
  display: flex; align-items: flex-end; justify-content: center;
  opacity: 0; pointer-events: none; transition: opacity 0.3s;
}
.modal-overlay.open { opacity: 1; pointer-events: all; }
.modal {
  background: var(--bg2);
  border: 1px solid var(--border);
  border-radius: var(--radius) var(--radius) 0 0;
  padding: 24px 20px calc(24px + env(safe-area-inset-bottom));
  width: 100%; max-width: 420px;
  transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.34,1.56,0.64,1);
  max-height: 90vh; overflow-y: auto;
}
.modal-overlay.open .modal { transform: translateY(0); }
.modal-handle { width: 40px; height: 4px; background: var(--border); border-radius: 2px; margin: 0 auto 20px; }
.modal-title { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; margin-bottom: 20px; }

/* ===== TREE / RESULT ===== */
#result-page { padding: 20px 16px; max-width: 420px; margin: 0 auto; }
.tree-container {
  background: linear-gradient(180deg, #0a1628 0%, #0d1f0d 100%);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 20px; text-align: center;
  margin-bottom: 16px; position: relative;
  overflow: hidden; min-height: 280px;
}
.tree-canvas { width: 100%; max-width: 240px; margin: 0 auto; display: block; }

/* ===== GRASS GRID ===== */
.grass-grid {
  display: grid; grid-template-columns: repeat(18, 1fr);
  gap: 3px; margin-top: 16px;
}
.grass-cell {
  aspect-ratio: 1; border-radius: 3px;
  background: var(--card);
}
.grass-cell.g1 { background: #1a4a1a; }
.grass-cell.g2 { background: #2d7a2d; }
.grass-cell.g3 { background: #3aaa3a; }
.grass-cell.g4 { background: #4ccc4c; }

/* ===== ANALYTICS ===== */
.stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px; }
.stat-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 16px; text-align: center;
}
.stat-num {
  font-family: 'Syne', sans-serif; font-size: 28px; font-weight: 800;
  color: var(--accent);
}
.stat-label { font-size: 12px; color: var(--text2); margin-top: 4px; }

/* ===== NOTES / TASKS ===== */
.note-card {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 16px; margin-bottom: 10px;
  cursor: pointer; transition: border-color 0.2s;
}
.note-card:hover { border-color: var(--accent); }
.note-title-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 6px; }
.note-name { font-weight: 600; font-size: 15px; }
.note-preview { font-size: 13px; color: var(--text2); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
.note-type-badge {
  font-size: 10px; font-weight: 700; padding: 2px 8px;
  border-radius: 10px; text-transform: uppercase;
}
.badge-note { background: rgba(124,58,237,0.2); color: #a78bfa; border: 1px solid rgba(124,58,237,0.3); }
.badge-task { background: rgba(0,212,255,0.1); color: var(--accent); border: 1px solid rgba(0,212,255,0.2); }
.badge-sheet { background: rgba(0,230,118,0.1); color: var(--green); border: 1px solid rgba(0,230,118,0.2); }

/* ===== TASKS ===== */
.task-item {
  display: flex; align-items: center; gap: 12px;
  padding: 12px 0; border-bottom: 1px solid var(--border);
}
.task-check {
  width: 22px; height: 22px; border-radius: 50%;
  border: 2px solid var(--border); flex-shrink: 0;
  cursor: pointer; display: flex; align-items: center; justify-content: center;
  transition: all 0.2s; font-size: 11px;
}
.task-item.done .task-check { background: var(--green); border-color: var(--green); color: #000; }
.task-item.done .task-text { text-decoration: line-through; color: var(--text3); }
.all-done-msg {
  text-align: center; padding: 24px; color: var(--green);
  font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700;
  display: none;
}

/* ===== SETTINGS ===== */
.settings-section { margin-bottom: 24px; }
.settings-title { font-size: 11px; font-weight: 700; color: var(--text3); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; }
.settings-item {
  background: var(--card); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 16px;
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 8px; cursor: pointer; transition: border-color 0.2s;
}
.settings-item:hover { border-color: var(--accent); }
.settings-item-left { display: flex; align-items: center; gap: 12px; }
.settings-icon { font-size: 20px; }
.settings-text { font-size: 14px; font-weight: 500; }
.settings-sub { font-size: 12px; color: var(--text2); margin-top: 2px; }

/* ===== PROFILE CARD ===== */
.profile-card {
  background: linear-gradient(135deg, var(--card), var(--card2));
  border: 1px solid var(--border); border-radius: var(--radius);
  padding: 20px; margin-bottom: 20px;
  text-align: center; position: relative;
}
.profile-avatar {
  width: 72px; height: 72px; border-radius: 50%;
  background: linear-gradient(135deg, var(--accent), #7c3aed);
  display: flex; align-items: center; justify-content: center;
  font-size: 30px; margin: 0 auto 12px;
}
.profile-name { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 700; }
.profile-sub { color: var(--text2); font-size: 13px; margin-top: 4px; }

/* ===== TOGGLE ===== */
.toggle {
  width: 48px; height: 26px; border-radius: 13px;
  background: var(--border); position: relative; cursor: pointer;
  transition: background 0.2s; flex-shrink: 0;
}
.toggle.on { background: var(--accent); }
.toggle::after {
  content: ''; position: absolute;
  width: 22px; height: 22px; border-radius: 50%;
  background: white; top: 2px; left: 2px;
  transition: transform 0.2s;
  box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
.toggle.on::after { transform: translateX(22px); }

/* ===== TOAST ===== */
#toast {
  position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-80px);
  background: var(--card2); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 12px 20px;
  font-size: 14px; font-weight: 500; z-index: 9999;
  transition: transform 0.4s cubic-bezier(0.34,1.56,0.64,1);
  max-width: 300px; text-align: center;
  box-shadow: var(--shadow);
  white-space: nowrap;
}
#toast.show { transform: translateX(-50%) translateY(0); }

/* ===== CELEBRATION ===== */
#celebration-overlay {
  position: fixed; inset: 0; z-index: 9997;
  background: rgba(0,0,0,0.8); backdrop-filter: blur(12px);
  display: flex; flex-direction: column; align-items: center; justify-content: center;
  gap: 16px; pointer-events: none; opacity: 0; transition: opacity 0.4s;
}
#celebration-overlay.show { opacity: 1; pointer-events: all; }
.celebration-emoji { font-size: 80px; animation: bounce 0.6s ease-in-out infinite alternate; }
.celebration-msg { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; text-align: center; padding: 0 24px; }
.celebration-sub { color: var(--text2); font-size: 14px; text-align: center; }
@keyframes bounce { from{transform:scale(0.9)} to{transform:scale(1.1)} }

/* ===== WARNING BANNER ===== */
.warning-banner {
  background: linear-gradient(135deg, rgba(255,152,0,0.15), rgba(255,87,34,0.1));
  border: 1px solid rgba(255,152,0,0.3);
  border-radius: var(--radius-sm); padding: 12px 16px;
  margin-bottom: 16px; display: flex; align-items: center; gap: 12px;
}
.warning-icon { font-size: 24px; flex-shrink: 0; }
.warning-text { font-size: 13px; color: var(--yellow); line-height: 1.4; }

/* ===== XP WATER DISPLAY ===== */
.xp-card {
  background: linear-gradient(135deg, rgba(0,100,200,0.2), rgba(0,50,150,0.1));
  border: 1px solid rgba(0,150,255,0.2);
  border-radius: var(--radius-sm); padding: 16px;
  display: flex; align-items: center; gap: 16px; margin-bottom: 16px;
}
.xp-icon { font-size: 36px; }
.xp-num {
  font-family: 'Syne', sans-serif; font-size: 32px; font-weight: 800;
  color: #4fc3f7;
}
.xp-label { font-size: 12px; color: var(--text2); }

/* ===== THEME COLORS ===== */
.theme-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
.theme-dot {
  aspect-ratio: 1; border-radius: 50%; cursor: pointer;
  border: 3px solid transparent; transition: all 0.2s;
}
.theme-dot.active { border-color: white; transform: scale(1.1); }

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar { width: 4px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

/* ===== CHIPS ===== */
.chip-row { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; }
.chip {
  padding: 6px 14px; border-radius: 20px;
  background: var(--card); border: 1.5px solid var(--border);
  font-size: 13px; font-weight: 500; cursor: pointer;
  transition: all 0.2s;
}
.chip.selected, .chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-soft); }

/* ===== MEDAL ===== */
.medal-card {
  background: linear-gradient(135deg, rgba(255,215,64,0.1), rgba(255,152,0,0.05));
  border: 1px solid rgba(255,215,64,0.2);
  border-radius: var(--radius-sm); padding: 14px;
  display: flex; align-items: center; gap: 12px; margin-bottom: 10px;
}
.medal-icon { font-size: 36px; }
.medal-info { flex: 1; }
.medal-name { font-weight: 700; font-size: 15px; }
.medal-desc { font-size: 12px; color: var(--text2); margin-top: 2px; }

/* ===== PROGRESS BAR ===== */
.progress-bar { height: 6px; background: var(--border); border-radius: 3px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 3px; background: linear-gradient(90deg, var(--accent), var(--green)); transition: width 0.5s ease; }

/* ===== TREE STAGES ===== */
.tree-stage { font-size: 80px; line-height: 1; }
.tree-weather { font-size: 24px; margin-top: 8px; }
.tree-msg { font-size: 13px; color: var(--text2); margin-top: 8px; font-style: italic; }

/* ===== SECTION HEADER ROW ===== */
.section-header-row {
  display: flex; align-items: center; gap: 8px; margin-bottom: 12px;
}
.section-emoji-big { font-size: 22px; }
.section-name-text { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 700; flex: 1; }
.section-actions { display: flex; gap: 6px; }
.icon-btn {
  width: 32px; height: 32px; border-radius: 8px;
  background: var(--card); border: 1px solid var(--border);
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 16px; transition: all 0.2s;
}
.icon-btn:hover { border-color: var(--accent); }
.icon-btn.danger:hover { border-color: var(--red); }

/* ===== NOTE EDITOR ===== */
.note-textarea {
  width: 100%; min-height: 150px;
  background: var(--card); border: 1.5px solid var(--border);
  border-radius: var(--radius-sm); color: var(--text);
  font-family: 'DM Sans', sans-serif; font-size: 14px;
  padding: 14px; resize: vertical; outline: none;
  line-height: 1.6; transition: border-color 0.2s;
}
.note-textarea:focus { border-color: var(--accent); }

/* ===== DATE BADGE ===== */
.date-badge {
  background: var(--card); border: 1px solid var(--border);
  border-radius: 20px; padding: 4px 14px;
  font-size: 12px; color: var(--text2);
}

/* ===== STREAK WARNING ===== */
.streak-warn-card {
  background: linear-gradient(135deg, rgba(255,23,68,0.1), rgba(255,87,34,0.05));
  border: 1px solid rgba(255,23,68,0.2);
  border-radius: var(--radius-sm); padding: 14px 16px;
  margin-bottom: 16px; display: flex; align-items: center; gap: 12px;
}

.confetti-container {
  position: fixed; inset: 0; pointer-events: none; z-index: 9998; overflow: hidden;
}
.confetti-piece {
  position: absolute; width: 8px; height: 8px; border-radius: 2px;
  animation: confettiFall 3s ease-in forwards;
}
@keyframes confettiFall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 1; }
  100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
}

/* ===== BIRTHDAY CARD ===== */
.birthday-card {
  background: linear-gradient(135deg, rgba(255,105,180,0.15), rgba(255,215,0,0.1));
  border: 1px solid rgba(255,105,180,0.3);
  border-radius: var(--radius); padding: 20px; text-align: center;
  margin-bottom: 16px;
}
.birthday-emoji { font-size: 48px; margin-bottom: 8px; }
.birthday-msg { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 700; }
.birthday-sub { color: var(--text2); font-size: 13px; margin-top: 6px; }
</style>
</head>
<body>

<!-- SPLASH -->
<div id="splash">
  <svg class="splash-logo" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <circle cx="50" cy="50" r="45" fill="none" stroke="#1e2d47" stroke-width="4"/>
    <path d="M30 50 Q35 65 50 70 Q65 65 70 50" fill="none" stroke="#00d4ff" stroke-width="5" stroke-linecap="round"/>
    <path d="M68 35 Q72 45 70 50" fill="none" stroke="#333" stroke-width="4" stroke-linecap="round"/>
    <path d="M40 50 L48 60 L65 38" stroke="#00d4ff" stroke-width="6" stroke-linecap="round" stroke-linejoin="round" fill="none"/>
    <circle cx="78" cy="88" r="5" fill="#00d4ff" opacity="0.5"/>
  </svg>
  <div class="splash-title">Replace Deeds</div>
  <div class="splash-sub">Loading your journey...</div>
</div>

<!-- ONBOARDING -->
<div id="onboarding">
  <div class="onboard-screen" id="ob-welcome">
    <div class="onboard-icon">‚ú®</div>
    <div class="onboard-title">Welcome to Replace Deeds</div>
    <div class="onboard-desc">Build powerful habits, track your streaks, and grow your tree of success ‚Äî one day at a time.</div>
    <div style="display:flex;flex-direction:column;gap:12px">
      <button class="btn btn-primary" onclick="showOnboard('ob-profile')">Let's Get Started ‚Üí</button>
    </div>
  </div>

  <div class="onboard-screen" id="ob-profile" style="display:none">
    <div class="onboard-icon">üë§</div>
    <div class="onboard-title">Create Your Profile</div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="form-group">
        <label class="form-label">Your Name</label>
        <input class="form-input" id="ob-name" placeholder="Enter your name" type="text">
      </div>
      <div class="form-group">
        <label class="form-label">Father's Name</label>
        <input class="form-input" id="ob-father" placeholder="Enter father's name" type="text">
      </div>
      <div class="form-group">
        <label class="form-label">Date of Birth</label>
        <input class="form-input" id="ob-dob" type="date">
      </div>
      <div class="form-group">
        <label class="form-label">Username / ID</label>
        <input class="form-input" id="ob-username" placeholder="Create a unique ID" type="text">
      </div>
      <div class="form-group">
        <label class="form-label">Password</label>
        <input class="form-input" id="ob-pass" placeholder="Set a password" type="password">
      </div>
    </div>
    <button class="btn btn-primary" onclick="saveProfile()">Continue ‚Üí</button>
  </div>
</div>

<!-- CELEBRATION -->
<div id="celebration-overlay" onclick="closeCelebration()">
  <div class="celebration-emoji" id="celeb-emoji">üî•</div>
  <div class="celebration-msg" id="celeb-msg">Amazing!</div>
  <div class="celebration-sub" id="celeb-sub">Keep going!</div>
  <button class="btn btn-primary btn-sm" style="margin-top:16px;width:auto;padding:12px 32px" onclick="closeCelebration()">Continue</button>
</div>
<div id="confetti-container" class="confetti-container"></div>

<!-- TOAST -->
<div id="toast"></div>

<!-- MAIN APP -->
<div id="main-app" style="display:none">

  <!-- HOME PAGE -->
  <div class="page active" id="page-home">
    <div class="page-header">
      <div>
        <div class="page-title" id="home-greeting">Good Morning üëã</div>
        <div class="date-badge" id="home-date">Today</div>
      </div>
      <div id="home-avatar" class="profile-avatar" style="width:44px;height:44px;font-size:18px;cursor:pointer" onclick="goPage('page-settings')">üë§</div>
    </div>

    <!-- Birthday Card -->
    <div class="birthday-card" id="birthday-card" style="display:none">
      <div class="birthday-emoji">üéÇ</div>
      <div class="birthday-msg" id="birthday-msg">Happy Birthday!</div>
      <div class="birthday-sub" id="birthday-sub"></div>
    </div>

    <!-- Warning Banner -->
    <div class="warning-banner" id="warning-banner" style="display:none">
      <div class="warning-icon">‚ö†Ô∏è</div>
      <div class="warning-text" id="warning-text">Complete your habits to maintain your streak!</div>
    </div>

    <!-- Streak Card -->
    <div class="streak-card" id="streak-card-main">
      <div class="streak-main">
        <div class="streak-fire" id="streak-fire-icon">üî•</div>
        <div>
          <div class="streak-num" id="streak-display">0</div>
          <div class="streak-label">day streak</div>
        </div>
        <div style="margin-left:auto;text-align:right">
          <div id="xp-mini" style="font-family:Syne,sans-serif;font-size:20px;font-weight:700;color:#4fc3f7">0 gal</div>
          <div style="font-size:11px;color:var(--text2)">üíß Water Total</div>
        </div>
      </div>
      <div id="freeze-indicator" style="display:none" class="freeze-badge">üßä Streak Frozen</div>

      <!-- Progress -->
      <div style="margin-top:14px">
        <div style="display:flex;justify-content:space-between;margin-bottom:6px;font-size:12px;color:var(--text2)">
          <span>Today's Progress</span>
          <span id="progress-text">0/0</span>
        </div>
        <div class="progress-bar"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
      </div>
    </div>

    <!-- Habit Sections -->
    <div id="sections-container"></div>

    <button class="add-section-btn" onclick="openModal('add-section-modal')">
      ‚ûï Add New Section
    </button>
  </div>

  <!-- TASKS / NOTES PAGE -->
  <div class="page" id="page-tasks">
    <div class="page-header">
      <div class="page-title">üìù Notes & Tasks</div>
      <button class="btn btn-primary btn-sm" onclick="openModal('add-note-modal')">+ New</button>
    </div>

    <!-- Tab Bar -->
    <div class="chip-row" id="notes-tabs">
      <div class="chip selected" onclick="filterNotes('all',this)">All</div>
      <div class="chip" onclick="filterNotes('note',this)">üìì Notes</div>
      <div class="chip" onclick="filterNotes('task',this)">‚úÖ Tasks</div>
      <div class="chip" onclick="filterNotes('sheet',this)">üìä Sheet</div>
    </div>

    <div id="notes-container"></div>
    <div class="all-done-msg" id="tasks-alldone">
      <div style="font-size:36px">üåü</div>
      <div>Alhamdulillah!</div>
      <div style="font-size:14px;font-weight:400;color:var(--text2);margin-top:6px">You are unbelievable! All tasks done!</div>
    </div>
  </div>

  <!-- RESULT / TREE PAGE -->
  <div class="page" id="page-result">
    <div class="page-header">
      <div class="page-title">üå± My Tree</div>
      <div id="day-count-badge" class="date-badge">Day 0</div>
    </div>

    <div class="tree-container" id="tree-container">
      <canvas class="tree-canvas" id="tree-canvas" width="240" height="240"></canvas>
      <div class="tree-weather" id="tree-weather"></div>
      <div class="tree-msg" id="tree-msg">Plant your first seed today üå±</div>
    </div>

    <!-- XP Water -->
    <div class="xp-card">
      <div class="xp-icon">üíß</div>
      <div>
        <div class="xp-num" id="xp-display">0 gal</div>
        <div class="xp-label">Total Water Gallons</div>
      </div>
      <div style="margin-left:auto;text-align:right">
        <div style="font-family:Syne,sans-serif;font-size:18px;font-weight:700;color:var(--green)" id="today-xp">+0</div>
        <div style="font-size:11px;color:var(--text2)">Today</div>
      </div>
    </div>

    <!-- Medal -->
    <div id="medal-display"></div>

    <!-- Streak Grass -->
    <div style="margin-bottom:16px">
      <div class="section-header">
        <div class="section-title">Activity History</div>
      </div>
      <div class="grass-grid" id="grass-grid"></div>
    </div>

    <!-- Stats -->
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-num" id="stat-streak">0</div>
        <div class="stat-label">üî• Current Streak</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="stat-best">0</div>
        <div class="stat-label">üèÜ Best Streak</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="stat-total">0</div>
        <div class="stat-label">‚úÖ Total Days</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="stat-habits">0</div>
        <div class="stat-label">üí™ Habits Done</div>
      </div>
    </div>
  </div>

  <!-- ANALYTICS PAGE -->
  <div class="page" id="page-analytics">
    <div class="page-header">
      <div class="page-title">üìä Analytics</div>
    </div>
    <div class="stat-grid">
      <div class="stat-card">
        <div class="stat-num" id="an-streak">0</div>
        <div class="stat-label">Current Streak</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="an-best">0</div>
        <div class="stat-label">Best Streak</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="an-water">0</div>
        <div class="stat-label">üíß Total Gallons</div>
      </div>
      <div class="stat-card">
        <div class="stat-num" id="an-habits">0</div>
        <div class="stat-label">Habits Created</div>
      </div>
    </div>
    <div style="background:var(--card);border:1px solid var(--border);border-radius:var(--radius);padding:16px;margin-bottom:16px">
      <div class="section-title" style="margin-bottom:12px">Weekly Completion</div>
      <canvas id="weekly-chart" height="120"></canvas>
    </div>
    <div id="per-habit-stats"></div>
  </div>

  <!-- SETTINGS PAGE -->
  <div class="page" id="page-settings">
    <div class="page-header">
      <div class="page-title">‚öôÔ∏è Settings</div>
    </div>

    <div class="profile-card">
      <div class="profile-avatar" id="settings-avatar">üë§</div>
      <div class="profile-name" id="settings-name">User</div>
      <div class="profile-sub" id="settings-info">ID: ‚Äî | DOB: ‚Äî</div>
    </div>

    <div class="settings-section">
      <div class="settings-title">Account</div>
      <div class="settings-item" onclick="openModal('edit-profile-modal')">
        <div class="settings-item-left">
          <span class="settings-icon">‚úèÔ∏è</span>
          <div>
            <div class="settings-text">Edit Profile</div>
            <div class="settings-sub">Name, DOB, ID</div>
          </div>
        </div>
        <span style="color:var(--text3)">‚Ä∫</span>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-title">App Theme</div>
      <div class="settings-item" style="flex-direction:column;align-items:flex-start;gap:12px">
        <div class="theme-grid" style="width:100%">
          <div class="theme-dot active" style="background:linear-gradient(135deg,#00d4ff,#0098b8)" onclick="setTheme('cyan',this)" title="Cyan"></div>
          <div class="theme-dot" style="background:linear-gradient(135deg,#7c3aed,#5b21b6)" onclick="setTheme('purple',this)" title="Purple"></div>
          <div class="theme-dot" style="background:linear-gradient(135deg,#00e676,#00c853)" onclick="setTheme('green',this)" title="Green"></div>
          <div class="theme-dot" style="background:linear-gradient(135deg,#ff6d00,#e65100)" onclick="setTheme('orange',this)" title="Orange"></div>
          <div class="theme-dot" style="background:linear-gradient(135deg,#ff1744,#c62828)" onclick="setTheme('red',this)" title="Red"></div>
          <div class="theme-dot" style="background:linear-gradient(135deg,#ffd740,#ff6f00)" onclick="setTheme('gold',this)" title="Gold"></div>
          <div class="theme-dot" style="background:linear-gradient(135deg,#e91e63,#880e4f)" onclick="setTheme('pink',this)" title="Pink"></div>
          <div class="theme-dot" style="background:linear-gradient(135deg,#b0bec5,#607d8b)" onclick="setTheme('silver',this)" title="Silver"></div>
        </div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-title">Streak</div>
      <div class="settings-item" onclick="freezeStreak()">
        <div class="settings-item-left">
          <span class="settings-icon">üßä</span>
          <div>
            <div class="settings-text">Freeze Streak</div>
            <div class="settings-sub" id="freeze-status-text">Protect today's streak</div>
          </div>
        </div>
        <div class="toggle" id="freeze-toggle" onclick="event.stopPropagation();freezeStreak()"></div>
      </div>
    </div>

    <div class="settings-section">
      <div class="settings-title">Data</div>
      <div class="settings-item" onclick="exportData()">
        <div class="settings-item-left">
          <span class="settings-icon">üì§</span>
          <div><div class="settings-text">Export Data</div></div>
        </div>
        <span style="color:var(--text3)">‚Ä∫</span>
      </div>
      <div class="settings-item" onclick="if(confirm('Reset all data? This cannot be undone.'))resetAll()">
        <div class="settings-item-left">
          <span class="settings-icon">üóëÔ∏è</span>
          <div><div class="settings-text" style="color:var(--red)">Reset All Data</div></div>
        </div>
        <span style="color:var(--text3)">‚Ä∫</span>
      </div>
    </div>

    <div style="text-align:center;color:var(--text3);font-size:12px;padding:20px 0">
      Replace Deeds v2.0 ‚Ä¢ Made with ‚ù§Ô∏è
    </div>
  </div>

</div>

<!-- NAV -->
<nav id="nav" style="display:none">
  <div class="nav-item active" onclick="goPage('page-home')" id="nav-home">
    <div class="nav-icon">üè†</div><span>Home</span>
  </div>
  <div class="nav-item" onclick="goPage('page-tasks')" id="nav-tasks">
    <div class="nav-icon">üìù</div><span>Notes</span>
  </div>
  <div class="nav-item" onclick="goPage('page-result')" id="nav-result">
    <div class="nav-icon">üå±</div><span>Result</span>
  </div>
  <div class="nav-item" onclick="goPage('page-analytics')" id="nav-analytics">
    <div class="nav-icon">üìä</div><span>Stats</span>
  </div>
  <div class="nav-item" onclick="goPage('page-settings')" id="nav-settings">
    <div class="nav-icon">‚öôÔ∏è</div><span>Settings</span>
  </div>
</nav>

<!-- MODALS -->

<!-- Add Section Modal -->
<div class="modal-overlay" id="add-section-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">New Section</div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="form-group">
        <label class="form-label">Section Name</label>
        <input class="form-input" id="new-section-name" placeholder="e.g. Morning Routine, Muslim, Student" type="text">
      </div>
      <div class="form-group">
        <label class="form-label">Emoji Icon</label>
        <div class="chip-row" id="section-emoji-picker">
          <div class="chip selected" onclick="selectEmoji(this,'üåô')">üåô</div>
          <div class="chip" onclick="selectEmoji(this,'üìö')">üìö</div>
          <div class="chip" onclick="selectEmoji(this,'üí™')">üí™</div>
          <div class="chip" onclick="selectEmoji(this,'üèÉ')">üèÉ</div>
          <div class="chip" onclick="selectEmoji(this,'ü§≤')">ü§≤</div>
          <div class="chip" onclick="selectEmoji(this,'üí°')">üí°</div>
          <div class="chip" onclick="selectEmoji(this,'üéØ')">üéØ</div>
          <div class="chip" onclick="selectEmoji(this,'‚ù§Ô∏è')">‚ù§Ô∏è</div>
          <div class="chip" onclick="selectEmoji(this,'üåü')">üåü</div>
          <div class="chip" onclick="selectEmoji(this,'üïå')">üïå</div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="addSection()">Create Section</button>
      <button class="btn btn-secondary" onclick="closeModal('add-section-modal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Add Habit Modal -->
<div class="modal-overlay" id="add-habit-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Add Habit</div>
    <input type="hidden" id="habit-section-id">
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="form-group">
        <label class="form-label">Habit Name</label>
        <input class="form-input" id="new-habit-name" placeholder="e.g. Read Quran, Drink Water" type="text">
      </div>
      <div class="form-group">
        <label class="form-label">Description (optional)</label>
        <input class="form-input" id="new-habit-desc" placeholder="Brief description" type="text">
      </div>
      <div class="form-group">
        <label class="form-label">Emoji</label>
        <div class="chip-row" id="habit-emoji-picker">
          <div class="chip selected" onclick="selectHabitEmoji(this,'‚úÖ')">‚úÖ</div>
          <div class="chip" onclick="selectHabitEmoji(this,'üìñ')">üìñ</div>
          <div class="chip" onclick="selectHabitEmoji(this,'üèÉ')">üèÉ</div>
          <div class="chip" onclick="selectHabitEmoji(this,'üíß')">üíß</div>
          <div class="chip" onclick="selectHabitEmoji(this,'üßò')">üßò</div>
          <div class="chip" onclick="selectHabitEmoji(this,'ü§≤')">ü§≤</div>
          <div class="chip" onclick="selectHabitEmoji(this,'üí™')">üí™</div>
          <div class="chip" onclick="selectHabitEmoji(this,'üåô')">üåô</div>
          <div class="chip" onclick="selectHabitEmoji(this,'‚≠ê')">‚≠ê</div>
        </div>
      </div>
      <button class="btn btn-primary" onclick="addHabit()">Add Habit</button>
      <button class="btn btn-secondary" onclick="closeModal('add-habit-modal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Add Note Modal -->
<div class="modal-overlay" id="add-note-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">New Note / Task</div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="form-group">
        <label class="form-label">Title</label>
        <input class="form-input" id="new-note-title" placeholder="Title..." type="text">
      </div>
      <div class="form-group">
        <label class="form-label">Type</label>
        <div class="chip-row">
          <div class="chip selected" onclick="selectNoteType(this,'note')">üìì Note</div>
          <div class="chip" onclick="selectNoteType(this,'task')">‚úÖ Task</div>
          <div class="chip" onclick="selectNoteType(this,'sheet')">üìä Sheet</div>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Content</label>
        <textarea class="note-textarea" id="new-note-content" placeholder="Write here..."></textarea>
      </div>
      <button class="btn btn-primary" onclick="addNote()">Save</button>
      <button class="btn btn-secondary" onclick="closeModal('add-note-modal')">Cancel</button>
    </div>
  </div>
</div>

<!-- Note View Modal -->
<div class="modal-overlay" id="view-note-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px">
      <div class="modal-title" id="view-note-title" style="margin-bottom:0">Note</div>
      <div id="view-note-badge"></div>
    </div>
    <div id="view-note-content" style="font-size:14px;color:var(--text2);line-height:1.7;white-space:pre-wrap;margin-bottom:20px"></div>
    <div id="view-note-tasks-list"></div>
    <div class="all-done-msg" id="note-alldone">
      <div style="font-size:28px">üåü</div>
      <div style="font-size:16px">Alhamdulillah!</div>
      <div style="font-size:13px;font-weight:400;color:var(--text2);margin-top:4px">You are unbelievable!</div>
    </div>
    <div style="display:flex;gap:8px;margin-top:16px">
      <button class="btn btn-danger btn-sm" onclick="deleteCurrentNote()">üóëÔ∏è Delete</button>
      <button class="btn btn-secondary btn-sm" style="flex:1" onclick="closeModal('view-note-modal')">Close</button>
    </div>
  </div>
</div>

<!-- Edit Profile Modal -->
<div class="modal-overlay" id="edit-profile-modal">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title">Edit Profile</div>
    <div style="display:flex;flex-direction:column;gap:14px">
      <div class="form-group">
        <label class="form-label">Name</label>
        <input class="form-input" id="edit-name" type="text">
      </div>
      <div class="form-group">
        <label class="form-label">Father's Name</label>
        <input class="form-input" id="edit-father" type="text">
      </div>
      <div class="form-group">
        <label class="form-label">Date of Birth</label>
        <input class="form-input" id="edit-dob" type="date">
      </div>
      <div class="form-group">
        <label class="form-label">Username</label>
        <input class="form-input" id="edit-username" type="text">
      </div>
      <button class="btn btn-primary" onclick="saveEditProfile()">Save Changes</button>
      <button class="btn btn-secondary" onclick="closeModal('edit-profile-modal')">Cancel</button>
    </div>
  </div>
</div>

<script>
// =============================================
// DATA LAYER (localStorage encrypted)
// =============================================
const SALT = 'RD_2024_SECURE';
function encode(data) { try { return btoa(unescape(encodeURIComponent(JSON.stringify(data)+SALT))); } catch(e){return '';} }
function decode(str) { try { const raw = decodeURIComponent(escape(atob(str))); return JSON.parse(raw.slice(0,-SALT.length)); } catch(e){return null;} }

function save(key, val) { try { localStorage.setItem(key, encode(val)); } catch(e){} }
function load(key, def=null) { const raw = localStorage.getItem(key); if(!raw) return def; const d = decode(raw); return d !== null ? d : def; }

// =============================================
// APP STATE
// =============================================
let state = {
  profile: null,
  sections: [],
  notes: [],
  streak: 0,
  bestStreak: 0,
  lastDate: null,
  frozen: false,
  frozenDate: null,
  xp: 0,
  todayXp: 0,
  totalDays: 0,
  totalHabitsDone: 0,
  completedDays: [],
  missedDays: [],
  weeklyData: {},
  habitHistory: {},
  treeDay: 0,
  warningDay: null,
};

const THEMES = {
  cyan:   { accent: '#00d4ff', accent2: '#0098b8' },
  purple: { accent: '#a855f7', accent2: '#7c3aed' },
  green:  { accent: '#00e676', accent2: '#00c853' },
  orange: { accent: '#ff9800', accent2: '#f57c00' },
  red:    { accent: '#ff5252', accent2: '#c62828' },
  gold:   { accent: '#ffd740', accent2: '#ff8f00' },
  pink:   { accent: '#f472b6', accent2: '#db2777' },
  silver: { accent: '#90a4ae', accent2: '#546e7a' },
};

let currentTheme = 'cyan';
let selectedSectionEmoji = 'üåô';
let selectedHabitEmoji = '‚úÖ';
let selectedNoteType = 'note';
let currentNoteId = null;
let currentNoteViewId = null;

// =============================================
// INIT
// =============================================
window.addEventListener('load', () => {
  setTimeout(() => {
    document.getElementById('splash').style.opacity = '0';
    document.getElementById('splash').style.transition = 'opacity 0.5s';
    setTimeout(() => {
      document.getElementById('splash').style.display = 'none';
      init();
    }, 500);
  }, 1800);
});

function init() {
  loadState();
  applyTheme(currentTheme);
  checkDayReset();
  checkBirthday();
  if (!state.profile) {
    document.getElementById('onboarding').style.display = 'flex';
  } else {
    showMainApp();
  }
}

function loadState() {
  const saved = load('rd_state');
  if (saved) Object.assign(state, saved);
  currentTheme = load('rd_theme', 'cyan');
}

function saveState() {
  save('rd_state', state);
}

// =============================================
// DAY RESET LOGIC
// =============================================
function getTodayStr() {
  const d = new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function checkDayReset() {
  const today = getTodayStr();
  if (state.lastDate === today) return;

  const yesterday = getDateStr(-1);
  if (state.lastDate && state.lastDate !== today) {
    // Check if previous day was completed
    const prevCompleted = state.completedDays.includes(state.lastDate);
    const prevMissed = !prevCompleted && state.lastDate !== today;

    if (prevMissed && !state.frozen) {
      if (!state.warningDay) {
        // First miss: warning
        state.warningDay = state.lastDate;
        showWarning();
      } else {
        // Second miss: reset streak
        state.streak = 0;
        state.warningDay = null;
        state.treeDay = Math.max(0, state.treeDay - 2);
        showToast('üò¢ Streak reset to Day 1!');
      }
    } else if (prevCompleted) {
      state.warningDay = null;
    }

    // Unfreeze
    if (state.frozen && state.frozenDate !== today) {
      state.frozen = false;
      state.frozenDate = null;
    }
  }

  // Reset today's habit completions
  state.sections.forEach(s => s.habits.forEach(h => { h.completedToday = false; }));
  state.todayXp = 0;
  state.lastDate = today;
  saveState();
}

function getDateStr(offset=0) {
  const d = new Date();
  d.setDate(d.getDate() + offset);
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
}

function showWarning() {
  const banner = document.getElementById('warning-banner');
  if (banner) {
    banner.style.display = 'flex';
    document.getElementById('warning-text').textContent = '‚ö†Ô∏è Warning! You missed yesterday. Complete all habits today or your streak resets!';
  }
}

// =============================================
// BIRTHDAY CHECK
// =============================================
function checkBirthday() {
  if (!state.profile?.dob) return;
  const dob = new Date(state.profile.dob);
  const today = new Date();
  if (dob.getMonth() === today.getMonth() && dob.getDate() === today.getDate()) {
    document.getElementById('birthday-card').style.display = 'block';
    document.getElementById('birthday-msg').textContent = `üéÇ Happy Birthday, ${state.profile.name}!`;
    document.getElementById('birthday-sub').textContent = `Wishing you a blessed day filled with happiness! üéâ`;
    spawnConfetti();
  }
}

// =============================================
// ONBOARDING
// =============================================
function showOnboard(id) {
  document.querySelectorAll('.onboard-screen').forEach(s => s.style.display = 'none');
  document.getElementById(id).style.display = 'flex';
}

function saveProfile() {
  const name = document.getElementById('ob-name').value.trim();
  const father = document.getElementById('ob-father').value.trim();
  const dob = document.getElementById('ob-dob').value;
  const username = document.getElementById('ob-username').value.trim();
  const pass = document.getElementById('ob-pass').value;
  if (!name || !username || !pass) { showToast('Please fill required fields'); return; }
  state.profile = { name, father, dob, username, pass };
  saveState();
  document.getElementById('onboarding').style.display = 'none';
  showMainApp();
  showCelebration('üéâ', `Welcome, ${name}!`, 'Your journey begins today');
}

// =============================================
// MAIN APP
// =============================================
function showMainApp() {
  document.getElementById('main-app').style.display = 'block';
  document.getElementById('nav').style.display = 'flex';
  updateHome();
  renderTree();
  updateSettings();
  updateAnalytics();
}

function goPage(pageId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.getElementById(pageId).classList.add('active');
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const navMap = {
    'page-home':'nav-home','page-tasks':'nav-tasks','page-result':'nav-result',
    'page-analytics':'nav-analytics','page-settings':'nav-settings'
  };
  if (navMap[pageId]) document.getElementById(navMap[pageId]).classList.add('active');

  if (pageId === 'page-result') { renderTree(); updateGrass(); }
  if (pageId === 'page-analytics') updateAnalytics();
  if (pageId === 'page-tasks') renderNotes();
  if (pageId === 'page-settings') updateSettings();
}

// =============================================
// UPDATE HOME
// =============================================
function updateHome() {
  const today = new Date();
  const hours = today.getHours();
  let greeting = hours < 12 ? 'üå§Ô∏è Good Morning' : hours < 17 ? '‚òÄÔ∏è Good Afternoon' : 'üåô Good Evening';
  if (state.profile) greeting += `, ${state.profile.name.split(' ')[0]}`;
  document.getElementById('home-greeting').textContent = greeting;
  document.getElementById('home-date').textContent = today.toLocaleDateString('en-US',{weekday:'long',month:'long',day:'numeric'});

  // Streak
  document.getElementById('streak-display').textContent = state.streak;
  document.getElementById('xp-mini').textContent = state.xp + ' gal';

  // Frozen indicator
  const fi = document.getElementById('freeze-indicator');
  fi.style.display = state.frozen ? 'inline-flex' : 'none';
  const sc = document.getElementById('streak-card-main');
  if (state.frozen) sc.classList.add('streak-frozen'); else sc.classList.remove('streak-frozen');
  if (state.frozen) document.getElementById('streak-fire-icon').textContent = 'üßä'; else document.getElementById('streak-fire-icon').textContent = 'üî•';

  // Warning
  if (state.warningDay) showWarning();

  renderSections();
  updateProgress();
  checkBirthday();
}

// =============================================
// SECTIONS & HABITS
// =============================================
function renderSections() {
  const container = document.getElementById('sections-container');
  container.innerHTML = '';
  state.sections.forEach(section => {
    const block = document.createElement('div');
    block.className = 'section-block';
    const completed = section.habits.filter(h => h.completedToday).length;
    const total = section.habits.length;
    block.innerHTML = `
      <div class="section-header-row">
        <div class="section-emoji-big">${section.emoji}</div>
        <div class="section-name-text">${section.name}</div>
        <div class="section-actions">
          <div class="icon-btn" onclick="openAddHabitModal('${section.id}')">‚ûï</div>
          <div class="icon-btn danger" onclick="deleteSection('${section.id}')">üóëÔ∏è</div>
        </div>
      </div>
      <div style="font-size:12px;color:var(--text2);margin-bottom:10px">${completed}/${total} completed</div>
      <div id="habits-${section.id}"></div>
    `;
    container.appendChild(block);
    renderHabits(section.id);
  });
}

function renderHabits(sectionId) {
  const section = state.sections.find(s => s.id === sectionId);
  if (!section) return;
  const container = document.getElementById(`habits-${sectionId}`);
  if (!container) return;
  container.innerHTML = '';
  section.habits.forEach(habit => {
    const card = document.createElement('div');
    card.className = `habit-card ${habit.completedToday ? 'completed' : ''}`;
    card.innerHTML = `
      <div class="habit-check">${habit.completedToday ? '‚úì' : ''}</div>
      <div class="habit-info">
        <div class="habit-name">${habit.emoji} ${habit.name}</div>
        ${habit.desc ? `<div class="habit-meta">${habit.desc}</div>` : ''}
      </div>
      <div class="habit-streak-badge">üî• ${habit.streak || 0}</div>
      <div class="icon-btn danger" style="flex-shrink:0" onclick="event.stopPropagation();deleteHabit('${sectionId}','${habit.id}')">‚úï</div>
    `;
    card.addEventListener('click', () => toggleHabit(sectionId, habit.id));
    container.appendChild(card);
  });
}

function toggleHabit(sectionId, habitId) {
  const section = state.sections.find(s => s.id === sectionId);
  if (!section) return;
  const habit = section.habits.find(h => h.id === habitId);
  if (!habit) return;

  habit.completedToday = !habit.completedToday;
  if (habit.completedToday) {
    habit.streak = (habit.streak || 0) + 1;
    state.xp += 10;
    state.todayXp += 10;
    state.totalHabitsDone++;
    showToast(getMotivationalMsg());
  } else {
    habit.streak = Math.max(0, (habit.streak || 1) - 1);
    state.xp = Math.max(0, state.xp - 10);
    state.todayXp = Math.max(0, state.todayXp - 10);
    state.totalHabitsDone = Math.max(0, state.totalHabitsDone - 1);
  }
  saveState();
  renderHabits(sectionId);
  updateProgress();
  checkAllDone();
}

function checkAllDone() {
  const allHabits = state.sections.flatMap(s => s.habits);
  if (allHabits.length === 0) return;
  const allDone = allHabits.every(h => h.completedToday);
  if (allDone) {
    const today = getTodayStr();
    if (!state.completedDays.includes(today)) {
      state.completedDays.push(today);
      state.streak++;
      state.treeDay++;
      if (state.streak > state.bestStreak) state.bestStreak = state.streak;
      state.totalDays++;
      saveState();

      // Water animation
      setTimeout(() => showWaterAnimation(), 500);
    }
  }
}

function updateProgress() {
  const allHabits = state.sections.flatMap(s => s.habits);
  const done = allHabits.filter(h => h.completedToday).length;
  const total = allHabits.length;
  const pct = total > 0 ? Math.round((done/total)*100) : 0;
  const pt = document.getElementById('progress-text');
  const pf = document.getElementById('progress-fill');
  if (pt) pt.textContent = `${done}/${total}`;
  if (pf) pf.style.width = pct + '%';

  // Update streak display
  const sd = document.getElementById('streak-display');
  if (sd) sd.textContent = state.streak;
  const xm = document.getElementById('xp-mini');
  if (xm) xm.textContent = state.xp + ' gal';
}

// =============================================
// ADD SECTION / HABIT
// =============================================
function addSection() {
  const name = document.getElementById('new-section-name').value.trim();
  if (!name) { showToast('Enter section name'); return; }
  const section = { id: Date.now().toString(), name, emoji: selectedSectionEmoji, habits: [] };
  state.sections.push(section);
  saveState();
  closeModal('add-section-modal');
  document.getElementById('new-section-name').value = '';
  renderSections();
  showToast(`Section "${name}" created!`);
}

function openAddHabitModal(sectionId) {
  document.getElementById('habit-section-id').value = sectionId;
  document.getElementById('new-habit-name').value = '';
  document.getElementById('new-habit-desc').value = '';
  openModal('add-habit-modal');
}

function addHabit() {
  const sectionId = document.getElementById('habit-section-id').value;
  const name = document.getElementById('new-habit-name').value.trim();
  if (!name) { showToast('Enter habit name'); return; }
  const desc = document.getElementById('new-habit-desc').value.trim();
  const section = state.sections.find(s => s.id === sectionId);
  if (!section) return;
  section.habits.push({ id: Date.now().toString(), name, desc, emoji: selectedHabitEmoji, streak: 0, completedToday: false });
  saveState();
  closeModal('add-habit-modal');
  renderHabits(sectionId);
  updateProgress();
  showToast(`Habit "${name}" added!`);
}

function deleteSection(id) {
  if (!confirm('Delete this section and all its habits?')) return;
  state.sections = state.sections.filter(s => s.id !== id);
  saveState();
  renderSections();
  updateProgress();
}

function deleteHabit(sectionId, habitId) {
  const section = state.sections.find(s => s.id === sectionId);
  if (!section) return;
  section.habits = section.habits.filter(h => h.id !== habitId);
  saveState();
  renderHabits(sectionId);
  updateProgress();
}

// =============================================
// EMOJI SELECTORS
// =============================================
function selectEmoji(el, emoji) {
  document.querySelectorAll('#section-emoji-picker .chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedSectionEmoji = emoji;
}

function selectHabitEmoji(el, emoji) {
  document.querySelectorAll('#habit-emoji-picker .chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedHabitEmoji = emoji;
}

function selectNoteType(el, type) {
  document.querySelectorAll('#add-note-modal .chip-row .chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  selectedNoteType = type;
}

// =============================================
// NOTES / TASKS
// =============================================
let noteFilter = 'all';

function filterNotes(type, el) {
  noteFilter = type;
  document.querySelectorAll('#notes-tabs .chip').forEach(c => c.classList.remove('selected'));
  el.classList.add('selected');
  renderNotes();
}

function renderNotes() {
  const container = document.getElementById('notes-container');
  let notes = state.notes;
  if (noteFilter !== 'all') notes = notes.filter(n => n.type === noteFilter);
  container.innerHTML = '';
  notes.forEach(note => {
    const card = document.createElement('div');
    card.className = 'note-card';
    const badgeClass = note.type === 'note' ? 'badge-note' : note.type === 'task' ? 'badge-task' : 'badge-sheet';
    const badgeLabel = note.type === 'note' ? 'üìì Note' : note.type === 'task' ? '‚úÖ Task' : 'üìä Sheet';
    let preview = note.content;
    if (note.type === 'task' && Array.isArray(note.tasks)) {
      const done = note.tasks.filter(t => t.done).length;
      preview = `${done}/${note.tasks.length} tasks done`;
    }
    card.innerHTML = `
      <div class="note-title-row">
        <div class="note-name">${note.title}</div>
        <div class="note-type-badge ${badgeClass}">${badgeLabel}</div>
      </div>
      <div class="note-preview">${preview || 'Empty'}</div>
    `;
    card.onclick = () => viewNote(note.id);
    container.appendChild(card);
  });
  if (notes.length === 0) {
    container.innerHTML = `<div style="text-align:center;padding:40px;color:var(--text3)">No ${noteFilter === 'all' ? 'notes' : noteFilter + 's'} yet. Tap + to add.</div>`;
  }
  checkTasksAllDone();
}

function addNote() {
  const title = document.getElementById('new-note-title').value.trim();
  if (!title) { showToast('Enter title'); return; }
  const content = document.getElementById('new-note-content').value.trim();
  const note = { id: Date.now().toString(), title, type: selectedNoteType, content, tasks: [] };
  if (selectedNoteType === 'task') {
    note.tasks = content.split('\n').filter(l => l.trim()).map((line, i) => ({
      id: i.toString(), text: line.trim(), done: false
    }));
  }
  state.notes.push(note);
  saveState();
  closeModal('add-note-modal');
  document.getElementById('new-note-title').value = '';
  document.getElementById('new-note-content').value = '';
  renderNotes();
}

function viewNote(id) {
  const note = state.notes.find(n => n.id === id);
  if (!note) return;
  currentNoteViewId = id;
  document.getElementById('view-note-title').textContent = note.title;
  const badgeClass = note.type === 'note' ? 'badge-note' : note.type === 'task' ? 'badge-task' : 'badge-sheet';
  const badgeLabel = note.type === 'note' ? 'üìì Note' : note.type === 'task' ? '‚úÖ Task' : 'üìä Sheet';
  document.getElementById('view-note-badge').innerHTML = `<div class="note-type-badge ${badgeClass}">${badgeLabel}</div>`;

  const contentEl = document.getElementById('view-note-content');
  const tasksList = document.getElementById('view-note-tasks-list');
  const alldone = document.getElementById('note-alldone');
  alldone.style.display = 'none';

  if (note.type === 'task' && note.tasks && note.tasks.length > 0) {
    contentEl.style.display = 'none';
    tasksList.innerHTML = '';
    tasksList.style.display = 'block';
    note.tasks.forEach(task => {
      const item = document.createElement('div');
      item.className = `task-item ${task.done ? 'done' : ''}`;
      item.innerHTML = `<div class="task-check" onclick="toggleTask('${id}','${task.id}')">${task.done ? '‚úì' : ''}</div><div class="task-text" style="flex:1;font-size:14px">${task.text}</div>`;
      tasksList.appendChild(item);
    });
    checkNoteAllDone(note, alldone);
  } else {
    contentEl.style.display = 'block';
    contentEl.textContent = note.content || '(Empty)';
    tasksList.style.display = 'none';
    if (note.type === 'sheet') {
      contentEl.style.fontFamily = 'monospace';
      contentEl.style.fontSize = '13px';
    } else {
      contentEl.style.fontFamily = '';
      contentEl.style.fontSize = '';
    }
  }
  openModal('view-note-modal');
}

function toggleTask(noteId, taskId) {
  const note = state.notes.find(n => n.id === noteId);
  if (!note) return;
  const task = note.tasks.find(t => t.id === taskId);
  if (!task) return;
  task.done = !task.done;
  saveState();
  viewNote(noteId);
}

function checkNoteAllDone(note, el) {
  if (note.tasks && note.tasks.length > 0 && note.tasks.every(t => t.done)) {
    el.style.display = 'block';
    spawnConfetti();
    showCelebration('üåü', 'Alhamdulillah!', getAmazingMsg());
  }
}

function checkTasksAllDone() {
  const taskNotes = state.notes.filter(n => n.type === 'task');
  const alldone = document.getElementById('tasks-alldone');
  if (taskNotes.length > 0 && taskNotes.every(n => n.tasks && n.tasks.every(t => t.done))) {
    alldone.style.display = 'block';
  } else {
    alldone.style.display = 'none';
  }
}

function deleteCurrentNote() {
  state.notes = state.notes.filter(n => n.id !== currentNoteViewId);
  saveState();
  closeModal('view-note-modal');
  renderNotes();
}

// =============================================
// TREE RENDERING
// =============================================
function renderTree() {
  const canvas = document.getElementById('tree-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width, H = canvas.height;
  ctx.clearRect(0, 0, W, H);

  const day = state.treeDay;
  const frozen = state.frozen;

  // Sky gradient
  const sky = ctx.createLinearGradient(0, 0, 0, H);
  if (frozen) {
    sky.addColorStop(0, '#0a1628');
    sky.addColorStop(1, '#0d1530');
  } else if (day >= 75) {
    sky.addColorStop(0, '#0a1a0a');
    sky.addColorStop(1, '#0d1f0d');
  } else {
    sky.addColorStop(0, '#080c14');
    sky.addColorStop(1, '#0f1520');
  }
  ctx.fillStyle = sky;
  ctx.fillRect(0, 0, W, H);

  // Ground
  ctx.fillStyle = '#1a3a1a';
  ctx.beginPath();
  ctx.ellipse(W/2, H-20, 80, 20, 0, 0, Math.PI*2);
  ctx.fill();

  if (day === 0) {
    // Seed
    ctx.fillStyle = '#8B6914';
    ctx.beginPath();
    ctx.ellipse(W/2, H-30, 10, 7, 0, 0, Math.PI*2);
    ctx.fill();
    ctx.fillStyle = '#00e676';
    ctx.beginPath();
    ctx.ellipse(W/2, H-40, 4, 6, 0.3, 0, Math.PI*2);
    ctx.fill();
  } else {
    drawTree(ctx, W, H, day, frozen);
  }

  // Update labels
  document.getElementById('day-count-badge').textContent = `Day ${day}`;
  document.getElementById('stat-streak').textContent = state.streak;
  document.getElementById('stat-best').textContent = state.bestStreak;
  document.getElementById('stat-total').textContent = state.totalDays;
  document.getElementById('stat-habits').textContent = state.totalHabitsDone;
  document.getElementById('xp-display').textContent = state.xp + ' gal';
  document.getElementById('today-xp').textContent = '+' + state.todayXp;

  updateTreeMsg();
  updateMedal();
  updateGrass();
}

function drawTree(ctx, W, H, day, frozen) {
  const cx = W/2;
  const groundY = H - 30;

  // Trunk height grows with days
  const trunkH = Math.min(day * 1.5, 100);
  const trunkW = Math.min(3 + day * 0.2, 14);

  // Trunk
  const trunkGrad = ctx.createLinearGradient(cx-trunkW, 0, cx+trunkW, 0);
  trunkGrad.addColorStop(0, '#3d2006');
  trunkGrad.addColorStop(0.5, '#7c4a1e');
  trunkGrad.addColorStop(1, '#3d2006');
  ctx.fillStyle = trunkGrad;

  if (frozen) {
    // Frozen: trunk bent
    ctx.beginPath();
    ctx.moveTo(cx-trunkW, groundY);
    ctx.quadraticCurveTo(cx-30, groundY-trunkH*0.6, cx-20, groundY-trunkH);
    ctx.quadraticCurveTo(cx-20+trunkW*2, groundY-trunkH, cx-20+trunkW*2, groundY-trunkH);
    ctx.quadraticCurveTo(cx-30+trunkW*2, groundY-trunkH*0.6, cx+trunkW, groundY);
    ctx.closePath();
    ctx.fill();
  } else {
    ctx.fillRect(cx - trunkW/2, groundY - trunkH, trunkW, trunkH);
  }

  // Leaves / crown
  const treeTop = frozen ? { x: cx-20, y: groundY-trunkH } : { x: cx, y: groundY-trunkH };
  if (day >= 3) {
    const crownSize = Math.min(15 + day * 0.8, 75);
    const leafOpacity = frozen ? 0.4 : 1;

    // Multiple leaf layers for fullness
    const layers = day >= 20 ? 3 : day >= 10 ? 2 : 1;
    for (let l = layers; l >= 0; l--) {
      const lSize = crownSize * (0.7 + l*0.15);
      const lY = treeTop.y - l * (lSize * 0.3);
      const greenShade = frozen ? `rgba(80,180,200,${leafOpacity})` :
        day >= 75 ? `rgba(0,${150+l*30},${50+l*20},${leafOpacity})` :
        `rgba(0,${120+l*40},${30+l*20},${leafOpacity})`;
      ctx.fillStyle = greenShade;
      ctx.beginPath();
      ctx.ellipse(treeTop.x, lY, lSize * 0.85, lSize, 0, 0, Math.PI*2);
      ctx.fill();
    }

    // Dense foliage after day 75
    if (day >= 75) {
      for (let i = 0; i < 8; i++) {
        const a = (i/8)*Math.PI*2;
        const r = crownSize * 0.6;
        ctx.fillStyle = `rgba(0,180,60,0.4)`;
        ctx.beginPath();
        ctx.ellipse(treeTop.x + Math.cos(a)*r*0.7, treeTop.y + Math.sin(a)*r*0.5, crownSize*0.3, crownSize*0.35, a, 0, Math.PI*2);
        ctx.fill();
      }
    }

    // Fruits after day 75
    if (day >= 75) {
      const fruitCount = Math.min(Math.floor((day-75)/3)+1, 12);
      for (let i = 0; i < fruitCount; i++) {
        const a = (i/fruitCount)*Math.PI*2;
        const r = crownSize * 0.55;
        const fx = treeTop.x + Math.cos(a)*r;
        const fy = treeTop.y + Math.sin(a)*r*0.6 + crownSize*0.1;
        ctx.fillStyle = '#ff4444';
        ctx.beginPath();
        ctx.arc(fx, fy, 5, 0, Math.PI*2);
        ctx.fill();
        ctx.fillStyle = '#ff6666';
        ctx.beginPath();
        ctx.arc(fx-1, fy-1, 2, 0, Math.PI*2);
        ctx.fill();
      }
    }

    // Spring blossoms if 3 good days in a row
    if (day >= 3 && state.streak >= 3 && !frozen) {
      for (let i = 0; i < 5; i++) {
        const a = (i/5)*Math.PI*2 + Date.now()*0.0001;
        const r = crownSize * 0.4;
        ctx.fillStyle = 'rgba(255,192,203,0.7)';
        ctx.beginPath();
        ctx.arc(treeTop.x + Math.cos(a)*r, treeTop.y + Math.sin(a)*r*0.6, 4, 0, Math.PI*2);
        ctx.fill();
      }
    }
  }

  // Day 365 explosion effect placeholder (handled in celebration)
}

function updateTreeMsg() {
  const msgEl = document.getElementById('tree-msg');
  const weatherEl = document.getElementById('tree-weather');
  const day = state.treeDay;
  const frozen = state.frozen;
  const streak = state.streak;

  let msg = '';
  let weather = '';

  if (frozen) {
    const frozenMsgs = ["Hanging on by a thread... ü•∂", "Just surviving today üßä", "This too shall pass ‚ùÑÔ∏è", "Come back stronger tomorrow üí™"];
    msg = frozenMsgs[Math.floor(Math.random()*frozenMsgs.length)];
    weather = '‚ùÑÔ∏èüå®Ô∏è';
  } else if (streak >= 3) {
    weather = 'üå∏‚òÄÔ∏è';
    msg = "Spring is in the air! 3+ day streak! üå∫";
  } else if (day >= 365) {
    weather = 'üèÜ‚ú®';
    msg = "A YEAR OF EXCELLENCE! You are LEGENDARY! üèÜ";
  } else if (day >= 75) {
    weather = 'üçéüå≥';
    msg = "Look at those fruits! Pure dedication! üçé";
  } else if (day >= 50) {
    weather = 'üå≥üíö';
    msg = "50 days! Your tree is magnificent! üåü";
  } else if (day >= 20) {
    weather = 'üåøüå±';
    msg = "Growing strong! Keep watering your tree! üíß";
  } else if (day >= 10) {
    weather = 'üå±';
    msg = "Roots are deepening! Great work! üôå";
  } else if (day >= 3) {
    weather = 'üå±';
    msg = "Your tree is sprouting! 3 days in! üåø";
  } else if (day === 1) {
    msg = "The seed is planted! ‚ú® Journey begins!";
    weather = 'üå±';
  } else {
    msg = "Plant your first seed today üå±";
    weather = '';
  }

  if (msgEl) msgEl.textContent = msg;
  if (weatherEl) weatherEl.textContent = weather;
}

function updateMedal() {
  const el = document.getElementById('medal-display');
  if (!el) return;
  const day = state.treeDay;
  let medal = null;
  if (day >= 350) medal = { icon: 'üèÜ', name: 'Diamond Success Cup', desc: 'The rarest achievement! 350+ days of excellence!' };
  else if (day >= 250) medal = { icon: 'üíé', name: 'Platinum Medal', desc: '250+ days ‚Äî Truly extraordinary!' };
  else if (day >= 150) medal = { icon: 'ü•á', name: 'Gold Medal', desc: '150+ days ‚Äî Elite performer!' };
  else if (day >= 100) medal = { icon: 'ü•à', name: 'Silver Medal', desc: '100+ days ‚Äî Outstanding dedication!' };
  else if (day >= 50) medal = { icon: 'ü•â', name: 'Bronze Medal', desc: '50+ days ‚Äî Great consistency!' };
  else if (day >= 1) medal = { icon: 'ü™µ', name: 'Wood Medal', desc: 'First step taken! Keep going!' };

  if (medal) {
    el.innerHTML = `<div class="medal-card"><div class="medal-icon">${medal.icon}</div><div class="medal-info"><div class="medal-name">${medal.name}</div><div class="medal-desc">${medal.desc}</div></div></div>`;
  } else {
    el.innerHTML = '';
  }
}

function updateGrass() {
  const grid = document.getElementById('grass-grid');
  if (!grid) return;
  grid.innerHTML = '';
  const days = 90;
  for (let i = days-1; i >= 0; i--) {
    const d = getDateStr(-i);
    const cell = document.createElement('div');
    cell.className = 'grass-cell';
    if (state.completedDays.includes(d)) {
      const streak = state.streak;
      const level = streak >= 30 ? 'g4' : streak >= 14 ? 'g3' : streak >= 7 ? 'g2' : 'g1';
      cell.classList.add(level);
    }
    cell.title = d;
    grid.appendChild(cell);
  }
}

// =============================================
// WATER ANIMATION
// =============================================
function showWaterAnimation() {
  const xp = state.todayXp;
  showCelebration('üíß', `+${xp} Gallons Poured!`, getMotivationalMsg());
  renderTree();
}

// =============================================
// STREAK CONTROLS
// =============================================
function freezeStreak() {
  const today = getTodayStr();
  if (state.frozen && state.frozenDate === today) {
    state.frozen = false;
    state.frozenDate = null;
    showToast('Streak freeze removed');
  } else {
    state.frozen = true;
    state.frozenDate = today;
    showToast('üßä Streak frozen! Protected for today.');
  }
  const toggle = document.getElementById('freeze-toggle');
  if (toggle) toggle.classList.toggle('on', state.frozen);
  const ftext = document.getElementById('freeze-status-text');
  if (ftext) ftext.textContent = state.frozen ? 'üßä Active ‚Äî streak protected' : 'Protect today\'s streak';
  saveState();
  updateHome();
}

// =============================================
// ANALYTICS
// =============================================
function updateAnalytics() {
  document.getElementById('an-streak').textContent = state.streak;
  document.getElementById('an-best').textContent = state.bestStreak;
  document.getElementById('an-water').textContent = state.xp;
  const totalHabits = state.sections.reduce((a, s) => a + s.habits.length, 0);
  document.getElementById('an-habits').textContent = totalHabits;

  // Per-habit stats
  const container = document.getElementById('per-habit-stats');
  if (container) {
    container.innerHTML = '';
    state.sections.forEach(section => {
      if (section.habits.length === 0) return;
      const div = document.createElement('div');
      div.style.marginBottom = '16px';
      div.innerHTML = `<div class="section-title" style="margin-bottom:8px">${section.emoji} ${section.name}</div>`;
      section.habits.forEach(h => {
        div.innerHTML += `
          <div style="display:flex;align-items:center;gap:10px;padding:10px 0;border-bottom:1px solid var(--border)">
            <span style="font-size:18px">${h.emoji}</span>
            <div style="flex:1">
              <div style="font-size:13px;font-weight:500">${h.name}</div>
              <div class="progress-bar" style="margin-top:5px"><div class="progress-fill" style="width:${Math.min(100,(h.streak||0)*3)}%"></div></div>
            </div>
            <div class="habit-streak-badge">üî• ${h.streak || 0}</div>
          </div>`;
      });
      container.appendChild(div);
    });
  }

  // Weekly chart
  drawWeeklyChart();
}

function drawWeeklyChart() {
  const canvas = document.getElementById('weekly-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const W = canvas.width = canvas.offsetWidth || 300;
  const H = canvas.height;

  ctx.clearRect(0, 0, W, H);

  const days = 7;
  const labels = [];
  const values = [];
  const allHabits = state.sections.flatMap(s => s.habits);
  const total = allHabits.length || 1;

  for (let i = 6; i >= 0; i--) {
    const d = getDateStr(-i);
    const shortDay = new Date(d).toLocaleDateString('en',{weekday:'short'});
    labels.push(shortDay);
    values.push(state.completedDays.includes(d) ? 100 : 0);
  }

  const barW = (W - 20) / days;
  const maxH = H - 30;

  values.forEach((v, i) => {
    const x = 10 + i * barW + barW*0.1;
    const bW = barW * 0.8;
    const bH = (v/100) * maxH;
    const y = H - 20 - bH;

    // Bar
    const grad = ctx.createLinearGradient(0, y, 0, H-20);
    const ac = getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#00d4ff';
    grad.addColorStop(0, ac);
    grad.addColorStop(1, ac + '44');
    ctx.fillStyle = v > 0 ? grad : '#1e2d47';
    ctx.beginPath();
    ctx.roundRect(x, y, bW, Math.max(bH, 3), 3);
    ctx.fill();

    // Label
    ctx.fillStyle = '#4a6278';
    ctx.font = '10px DM Sans';
    ctx.textAlign = 'center';
    ctx.fillText(labels[i], x + bW/2, H - 5);
  });
}

// =============================================
// SETTINGS
// =============================================
function updateSettings() {
  if (!state.profile) return;
  document.getElementById('settings-name').textContent = state.profile.name;
  document.getElementById('settings-info').textContent = `@${state.profile.username} ‚Ä¢ ${state.profile.dob || '‚Äî'}`;
  document.getElementById('settings-avatar').textContent = state.profile.name[0].toUpperCase();
  document.getElementById('home-avatar').textContent = state.profile.name[0].toUpperCase();

  const ft = document.getElementById('freeze-toggle');
  if (ft) ft.classList.toggle('on', state.frozen);
  const ftext = document.getElementById('freeze-status-text');
  if (ftext) ftext.textContent = state.frozen ? 'üßä Active ‚Äî streak protected' : 'Protect today\'s streak';
}

function saveEditProfile() {
  state.profile.name = document.getElementById('edit-name').value.trim() || state.profile.name;
  state.profile.father = document.getElementById('edit-father').value.trim();
  state.profile.dob = document.getElementById('edit-dob').value;
  state.profile.username = document.getElementById('edit-username').value.trim() || state.profile.username;
  saveState();
  closeModal('edit-profile-modal');
  updateSettings();
  showToast('Profile updated!');
}

// Open edit profile modal with current values
function openEditProfileModal() {
  document.getElementById('edit-name').value = state.profile?.name || '';
  document.getElementById('edit-father').value = state.profile?.father || '';
  document.getElementById('edit-dob').value = state.profile?.dob || '';
  document.getElementById('edit-username').value = state.profile?.username || '';
  openModal('edit-profile-modal');
}

// =============================================
// THEME
// =============================================
function applyTheme(name) {
  const t = THEMES[name];
  if (!t) return;
  document.documentElement.style.setProperty('--accent', t.accent);
  document.documentElement.style.setProperty('--accent2', t.accent2);
  document.documentElement.style.setProperty('--accent-soft', t.accent + '20');
  document.documentElement.style.setProperty('--glow', `0 0 20px ${t.accent}40`);
  currentTheme = name;
  save('rd_theme', name);
}

function setTheme(name, el) {
  applyTheme(name);
  document.querySelectorAll('.theme-dot').forEach(d => d.classList.remove('active'));
  el.classList.add('active');
  showToast('Theme updated!');
}

// =============================================
// MODAL
// =============================================
function openModal(id) {
  document.getElementById(id).classList.add('open');
}

function closeModal(id) {
  document.getElementById(id).classList.remove('open');
}

document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === overlay) overlay.classList.remove('open');
  });
});

// =============================================
// TOAST
// =============================================
let toastTimer;
function showToast(msg) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => t.classList.remove('show'), 2500);
}

// =============================================
// CELEBRATION
// =============================================
function showCelebration(emoji, msg, sub) {
  document.getElementById('celeb-emoji').textContent = emoji;
  document.getElementById('celeb-msg').textContent = msg;
  document.getElementById('celeb-sub').textContent = sub;
  document.getElementById('celebration-overlay').classList.add('show');
  spawnConfetti();
}

function closeCelebration() {
  document.getElementById('celebration-overlay').classList.remove('show');
}

function spawnConfetti() {
  const container = document.getElementById('confetti-container');
  container.innerHTML = '';
  const colors = ['#00d4ff','#7c3aed','#00e676','#ffd740','#ff6d00','#ff1744','#f472b6'];
  for (let i = 0; i < 60; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    piece.style.left = Math.random()*100 + '%';
    piece.style.top = '-10px';
    piece.style.background = colors[Math.floor(Math.random()*colors.length)];
    piece.style.animationDelay = Math.random()*1.5 + 's';
    piece.style.animationDuration = (2+Math.random()*2) + 's';
    piece.style.width = (5+Math.random()*8) + 'px';
    piece.style.height = (5+Math.random()*8) + 'px';
    piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
    container.appendChild(piece);
  }
  setTimeout(() => container.innerHTML = '', 4000);
}

// =============================================
// MESSAGES
// =============================================
const motivationalMsgs = [
  "You are unbelievable! üöÄ",
  "Are you a robot? Too consistent! ü§ñ",
  "Mashallah! Keep it up! üåü",
  "You're on fire! üî•",
  "Unstoppable! Nothing can stop you! üí™",
  "You make it look easy! üòé",
  "Pure dedication! Keep going! ‚ö°",
  "You're built different! üèÜ",
  "Incredible consistency! Wow! ‚ú®",
  "Champions are made like this! ü•á",
];

const amazingMsgs = [
  "are you even human?! ü§ñ",
  "you're absolutely incredible!",
  "this is pure dedication!",
  "you make greatness look easy! üöÄ",
  "I'm in awe! Keep going! üåü",
];

function getMotivationalMsg() { return motivationalMsgs[Math.floor(Math.random()*motivationalMsgs.length)]; }
function getAmazingMsg() { return amazingMsgs[Math.floor(Math.random()*amazingMsgs.length)]; }

// =============================================
// EXPORT / RESET
// =============================================
function exportData() {
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = 'replace-deeds-backup.json';
  a.click();
  showToast('Data exported!');
}

function resetAll() {
  localStorage.clear();
  location.reload();
}

// =============================================
// SERVICE WORKER REGISTRATION
// =============================================
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

// =============================================
// MIDNIGHT RESET CHECKER
// =============================================
function checkMidnight() {
  const now = new Date();
  const nextMidnight = new Date(now);
  nextMidnight.setHours(24, 0, 0, 0);
  setTimeout(() => {
    checkDayReset();
    updateHome();
    checkMidnight();
  }, nextMidnight - now);
}
checkMidnight();

// =============================================
// SETTINGS ITEM CLICK - Edit Profile
// =============================================
document.querySelector('.settings-item')?.addEventListener('click', openEditProfileModal);
</script>
<script>
  if ('serviceWorker' in navigator) {
    window.addEventListener('load', () => {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker Registered!', reg))
        .catch(err => console.log('Service Worker registration failed:', err));
    });
  }
</script></body>
</html>
